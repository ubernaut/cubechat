(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Mortice = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Mortice=(()=>{var G=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var le=Object.prototype.hasOwnProperty;var ce=(n,e)=>{for(var t in e)G(n,t,{get:e[t],enumerable:!0})},he=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ue(e))!le.call(n,i)&&i!==t&&G(n,i,{get:()=>e[i],enumerable:!(r=ae(e,i))||r.enumerable});return n};var de=n=>he(G({},"__esModule",{value:!0}),n);var Re={};ce(Re,{default:()=>se});var m=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function x(){let n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),n}var T=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},_=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new T(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new T(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var H=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function J(n={}){return fe(t=>{let r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function fe(n,e){e=e??{};let t=e.onEnd,r=new _,i,s,o,u=x(),a=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((l,p)=>{s=v=>{s=null,r.push(v);try{l(n(r))}catch(L){p(L)}return i}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{u.resolve(),u=x()})}},f=l=>s!=null?s(l):(r.push(l),i),c=l=>(r=new _,s!=null?s({error:l}):(r.push({error:l}),i)),h=l=>{if(o)return i;if(e?.objectMode!==!0&&l?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return f({done:!1,value:l})},d=l=>o?i:(o=!0,l!=null?c(l):f({done:!0})),E=()=>(r=new _,d(),{done:!0}),A=l=>(d(l),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:a,return:E,throw:A,push:h,end:d,get readableLength(){return r.size},onEmpty:async l=>{let p=l?.signal;if(p?.throwIfAborted(),r.isEmpty())return;let v,L;p!=null&&(v=new Promise((be,oe)=>{L=()=>{oe(new H)},p.addEventListener("abort",L)}));try{await Promise.race([u.promise,v])}finally{L!=null&&p!=null&&p?.removeEventListener("abort",L)}}},t==null)return i;let b=i;return i={[Symbol.asyncIterator](){return this},next(){return b.next()},throw(l){return b.throw(l),t!=null&&(t(l),t=void 0),{done:!0}},return(){return b.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(l){return b.end(l),t!=null&&(t(l),t=void 0),i},get readableLength(){return b.readableLength},onEmpty:l=>b.onEmpty(l)},i}var g=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let i=this.#e.get(e);i==null&&(i=[],this.#e.set(e,i)),i.push({callback:t,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let i=this.#e.get(e);i!=null&&(i=i.filter(({callback:s})=>s!==t),this.#e.set(e,i))}dispatchEvent(e){let t=super.dispatchEvent(e),r=this.#e.get(e.type);return r==null||(r=r.filter(({once:i})=>!i),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var V=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function O(n,e,t,r){let i=new V(r?.errorMessage,r?.errorCode);return t?.aborted===!0?Promise.reject(i):new Promise((s,o)=>{function u(){t?.removeEventListener("abort",c),n.removeEventListener(e,a),r?.errorEvent!=null&&n.removeEventListener(r.errorEvent,f)}let a=h=>{try{if(r?.filter?.(h)===!1)return}catch(d){u(),o(d);return}u(),s(h)},f=h=>{u(),o(h.detail)},c=()=>{u(),o(i)};t?.addEventListener("abort",c),n.addEventListener(e,a),r?.errorEvent!=null&&n.addEventListener(r.errorEvent,f)})}var S=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var k=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function X(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new k(t?.errorMessage,t?.errorCode,t?.errorName));let r,i=new k(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([n,new Promise((s,o)=>{r=()=>{o(i)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}var I=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new m)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function Ee(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var C=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=Ee(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new m),this.cleanup())}async join(e={}){let t=new I(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await X(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function Z(n,e){let t,r=function(){let i=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(i,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}var y=class extends g{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Z(this.emitEmpty.bind(this),1),this.emitIdle=Z(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new S;let r=new C(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(t).then(i=>(this.safeDispatchEvent("success",{detail:{job:r,result:i}}),i)).catch(i=>{if(r.status==="queued"){for(let s=0;s<this.queue.length;s++)if(this.queue[s]===r){this.queue.splice(s,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:i}}),i})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new m)}),this.clear()}async onEmpty(e){this.size!==0&&await O(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await O(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await O(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=J({objectMode:!0}),r=a=>{a!=null?this.abort():this.clear(),t.end(a)},i=a=>{a.detail!=null&&t.push(a.detail.result)},s=a=>{r(a.detail.error)},o=()=>{r()},u=()=>{r(new m("Queue aborted"))};this.addEventListener("success",i),this.addEventListener("failure",s),this.addEventListener("idle",o),e?.signal?.addEventListener("abort",u);try{yield*t}finally{this.removeEventListener("success",i),this.removeEventListener("failure",s),this.removeEventListener("idle",o),e?.signal?.removeEventListener("abort",u),r()}}};var K="lock:worker:request-read",q="lock:worker:abort-read-request",W="lock:worker:release-read",M="lock:master:grant-read",D="lock:master:error-read",N="lock:worker:request-write",z="lock:worker:abort-write-request",P="lock:worker:release-write",Q="lock:master:grant-write",B="lock:master:error-write",U="lock:worker:finalize",j="mortice",ee={singleProcess:!1};var Y=(n,e,t,r,i,s,o,u,a)=>f=>{if(f.data==null)return;let c={type:f.data.type,name:f.data.name,identifier:f.data.identifier};c.type===i&&n.safeDispatchEvent(t,{detail:{name:c.name,identifier:c.identifier,handler:async()=>{e.postMessage({type:a,name:c.name,identifier:c.identifier}),await new Promise(h=>{let d=E=>{if(E?.data==null)return;let A={type:E.data.type,name:E.data.name,identifier:E.data.identifier};A.type===u&&A.identifier===c.identifier&&(e.removeEventListener("message",d),h())};e.addEventListener("message",d)})},onError:h=>{e.postMessage({type:o,name:c.name,identifier:c.identifier,error:{message:h.message,name:h.name,stack:h.stack}})}}}),c.type===s&&n.safeDispatchEvent(r,{detail:{name:c.name,identifier:c.identifier}}),c.type===U&&n.safeDispatchEvent("finalizeRequest",{detail:{name:c.name}})};var te=(n=10)=>Math.random().toString().substring(2,n+2);var F=class{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(j)}readLock(e){return this.sendRequest(K,q,M,D,W,e)}writeLock(e){return this.sendRequest(N,z,Q,B,P,e)}finalize(){this.channel.postMessage({type:U,name:this.name}),this.channel.close()}async sendRequest(e,t,r,i,s,o){o?.signal?.throwIfAborted();let u=te();return this.channel.postMessage({type:e,identifier:u,name:this.name}),new Promise((a,f)=>{let c=()=>{this.channel.postMessage({type:t,identifier:u,name:this.name})};o?.signal?.addEventListener("abort",c,{once:!0});let h=d=>{if(d.data?.identifier===u&&(d.data?.type===r&&(this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",c),a(()=>{this.channel.postMessage({type:s,identifier:u,name:this.name})})),d.data.type===i)){this.channel.removeEventListener("message",h),o?.signal?.removeEventListener("abort",c);let E=new Error;d.data.error!=null&&(E.message=d.data.error.message,E.name=d.data.error.name,E.stack=d.data.error.stack),f(E)}};this.channel.addEventListener("message",h)})}};var re=n=>{if(n=Object.assign({},ee,n),!!globalThis.document||n.singleProcess){let t=new BroadcastChannel(j),r=new g;return t.addEventListener("message",Y(r,t,"requestReadLock","abortReadLockRequest",K,q,D,W,M)),t.addEventListener("message",Y(r,t,"requestWriteLock","abortWriteLockRequest",N,z,B,P,Q)),r}return new F(n.name)};var R=new Map,w;function ne(n){return typeof n?.readLock=="function"&&typeof n?.writeLock=="function"}function me(n){if(w==null&&(w=re(n),!ne(w))){let e=w;e.addEventListener("requestReadLock",t=>{let r=t.detail.name,i=t.detail.identifier,s=R.get(r);if(s==null)return;let o=new AbortController,u=a=>{a.detail.name!==r||a.detail.identifier!==i||o.abort()};e.addEventListener("abortReadLockRequest",u),s.readLock({signal:o.signal}).then(async a=>{await t.detail.handler().finally(()=>{a()})}).catch(a=>{t.detail.onError(a)}).finally(()=>{e.removeEventListener("abortReadLockRequest",u)})}),e.addEventListener("requestWriteLock",t=>{let r=t.detail.name,i=t.detail.identifier,s=R.get(r);if(s==null)return;let o=new AbortController,u=a=>{a.detail.name!==r||a.detail.identifier!==i||o.abort()};e.addEventListener("abortWriteLockRequest",u),s.writeLock({signal:o.signal}).then(async a=>{await t.detail.handler().finally(()=>{a()})}).catch(a=>{t.detail.onError(a)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",u)})}),e.addEventListener("finalizeRequest",t=>{let r=t.detail.name,i=R.get(r);i?.finalize()})}return w}async function $(n,e){let t,r,i=new Promise((o,u)=>{t=o,r=u}),s=()=>{r(new m)};return e?.signal?.addEventListener("abort",s,{once:!0}),n.add(async()=>{await new Promise(o=>{t(()=>{e?.signal?.removeEventListener("abort",s),o()})})},{signal:e?.signal}).catch(o=>{r(o)}),i}var ie=(n,e)=>{let t=R.get(n);if(t!=null)return t;let r=me(e);if(ne(r))return t=r,R.set(n,t),t;let i=new y({concurrency:1}),s;return t={async readLock(o){if(s!=null)return $(s,o);s=new y({concurrency:e.concurrency,autoStart:!1});let u=s,a=$(s,o);return i.add(async()=>{u.start(),await u.onIdle().then(()=>{s===u&&(s=null)})}),a},async writeLock(o){return s=null,$(i,o)},finalize:()=>{R.delete(n)},queue:i},R.set(n,t),e.autoFinalize===!0&&i.addEventListener("idle",()=>{t.finalize()},{once:!0}),t};var pe={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function se(n){let e=Object.assign({},pe,n);return ie(e.name,e)}return de(Re);})();
return Mortice}));
//# sourceMappingURL=index.min.js.map
