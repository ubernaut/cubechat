(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ItQueue = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ItQueue=(()=>{var z=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var F=(s,e)=>{for(var t in e)z(s,t,{get:e[t],enumerable:!0})},B=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of O(e))!Q.call(s,n)&&n!==t&&z(s,n,{get:()=>e[n],enumerable:!(r=C(e,n))||r.enumerable});return s};var V=s=>B(z({},"__esModule",{value:!0}),s);var J={};F(J,{Queue:()=>N});var h=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function g(){let s={};return s.promise=new Promise((e,t)=>{s.resolve=e,s.reject=t}),s}var w=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},m=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new w(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new w(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var T=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function P(s={}){return G(t=>{let r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},s)}function G(s,e){e=e??{};let t=e.onEnd,r=new m,n,o,u,l=g(),a=async()=>{try{return r.isEmpty()?u?{done:!0}:await new Promise((i,d)=>{o=y=>{o=null,r.push(y);try{i(s(r))}catch(p){d(p)}return n}}):s(r)}finally{r.isEmpty()&&queueMicrotask(()=>{l.resolve(),l=g()})}},b=i=>o!=null?o(i):(r.push(i),n),v=i=>(r=new m,o!=null?o({error:i}):(r.push({error:i}),n)),c=i=>{if(u)return n;if(e?.objectMode!==!0&&i?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return b({done:!1,value:i})},E=i=>u?n:(u=!0,i!=null?v(i):b({done:!0})),k=()=>(r=new m,E(),{done:!0}),R=i=>(E(i),{done:!0});if(n={[Symbol.asyncIterator](){return this},next:a,return:k,throw:R,push:c,end:E,get readableLength(){return r.size},onEmpty:async i=>{let d=i?.signal;if(d?.throwIfAborted(),r.isEmpty())return;let y,p;d!=null&&(y=new Promise((U,_)=>{p=()=>{_(new T)},d.addEventListener("abort",p)}));try{await Promise.race([l.promise,y])}finally{p!=null&&d!=null&&d?.removeEventListener("abort",p)}}},t==null)return n;let f=n;return n={[Symbol.asyncIterator](){return this},next(){return f.next()},throw(i){return f.throw(i),t!=null&&(t(i),t=void 0),{done:!0}},return(){return f.return(),t!=null&&(t(),t=void 0),{done:!0}},push:c,end(i){return f.end(i),t!=null&&(t(i),t=void 0),n},get readableLength(){return f.readableLength},onEmpty:i=>f.onEmpty(i)},n}var x=class extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let n=this.#e.get(e);n==null&&(n=[],this.#e.set(e,n)),n.push({callback:t,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let n=this.#e.get(e);n!=null&&(n=n.filter(({callback:o})=>o!==t),this.#e.set(e,n))}dispatchEvent(e){let t=super.dispatchEvent(e),r=this.#e.get(e.type);return r==null||(r=r.filter(({once:n})=>!n),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}};var D=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.name="AbortError",this.code=t??"ABORT_ERR"}};async function L(s,e,t,r){let n=new D(r?.errorMessage,r?.errorCode);return t?.aborted===!0?Promise.reject(n):new Promise((o,u)=>{function l(){t?.removeEventListener("abort",v),s.removeEventListener(e,a),r?.errorEvent!=null&&s.removeEventListener(r.errorEvent,b)}let a=c=>{try{if(r?.filter?.(c)===!1)return}catch(E){l(),u(E);return}l(),o(c)},b=c=>{l(),u(c.detail)},v=()=>{l(),u(n)};t?.addEventListener("abort",v),s.addEventListener(e,a),r?.errorEvent!=null&&s.addEventListener(r.errorEvent,b)})}var S=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};var A=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function j(s,e,t){if(e==null)return s;if(e.aborted)return s.catch(()=>{}),Promise.reject(new A(t?.errorMessage,t?.errorCode,t?.errorName));let r,n=new A(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([s,new Promise((o,u)=>{r=()=>{u(n)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}var I=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new h)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function $(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var q=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=$(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new h),this.cleanup())}async join(e={}){let t=new I(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();let e=await j(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function M(s,e){let t,r=function(){let n=function(){t=void 0,s()};clearTimeout(t),t=setTimeout(n,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}var N=class extends x{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=M(this.emitEmpty.bind(this),1),this.emitIdle=M(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(let t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new S;let r=new q(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(t).then(n=>(this.safeDispatchEvent("success",{detail:{job:r,result:n}}),n)).catch(n=>{if(r.status==="queued"){for(let o=0;o<this.queue.length;o++)if(this.queue[o]===r){this.queue.splice(o,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:n}}),n})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new h)}),this.clear()}async onEmpty(e){this.size!==0&&await L(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await L(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await L(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();let t=P({objectMode:!0}),r=a=>{a!=null?this.abort():this.clear(),t.end(a)},n=a=>{a.detail!=null&&t.push(a.detail.result)},o=a=>{r(a.detail.error)},u=()=>{r()},l=()=>{r(new h("Queue aborted"))};this.addEventListener("success",n),this.addEventListener("failure",o),this.addEventListener("idle",u),e?.signal?.addEventListener("abort",l);try{yield*t}finally{this.removeEventListener("success",n),this.removeEventListener("failure",o),this.removeEventListener("idle",u),e?.signal?.removeEventListener("abort",l),r()}}};return V(J);})();
return ItQueue}));
//# sourceMappingURL=index.min.js.map
